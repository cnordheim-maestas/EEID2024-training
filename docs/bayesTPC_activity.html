<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>EEID2024 - Introduction to Bayesian Methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">EEID2024</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./schedule.html" rel="" target="">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./materials.html" rel="" target="">
 <span class="menu-text">Materials</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#packages-and-tools" id="toc-packages-and-tools" class="nav-link" data-scroll-target="#packages-and-tools">Packages and tools</a></li>
  <li><a href="#fitting-thermal-trait-data-for-aedes-mosquitoes" id="toc-fitting-thermal-trait-data-for-aedes-mosquitoes" class="nav-link" data-scroll-target="#fitting-thermal-trait-data-for-aedes-mosquitoes">Fitting thermal trait data for <em>Aedes</em> mosquitoes</a>
  <ul class="collapse">
  <li><a href="#data-from-vectraits" id="toc-data-from-vectraits" class="nav-link" data-scroll-target="#data-from-vectraits">Data from VecTraits</a></li>
  </ul></li>
  <li><a href="#thermal-performance-curve-models-in-bayestpc" id="toc-thermal-performance-curve-models-in-bayestpc" class="nav-link" data-scroll-target="#thermal-performance-curve-models-in-bayestpc">Thermal performance curve models in <code>bayesTPC</code></a></li>
  <li><a href="#sec-fitting" id="toc-sec-fitting" class="nav-link" data-scroll-target="#sec-fitting">Fitting using <code>bayesTPC</code></a></li>
  <li><a href="#example-1-adult-mosquito-lifespan" id="toc-example-1-adult-mosquito-lifespan" class="nav-link" data-scroll-target="#example-1-adult-mosquito-lifespan">Example 1: Adult Mosquito Lifespan</a>
  <ul class="collapse">
  <li><a href="#inference-with-default-settings" id="toc-inference-with-default-settings" class="nav-link" data-scroll-target="#inference-with-default-settings">Inference with default settings</a></li>
  <li><a href="#mcmc-diagnotic-plots" id="toc-mcmc-diagnotic-plots" class="nav-link" data-scroll-target="#mcmc-diagnotic-plots">MCMC Diagnotic Plots</a></li>
  <li><a href="#additional-plotting" id="toc-additional-plotting" class="nav-link" data-scroll-target="#additional-plotting">Additional plotting</a></li>
  <li><a href="#summaries" id="toc-summaries" class="nav-link" data-scroll-target="#summaries">Summaries</a></li>
  </ul></li>
  <li><a href="#example-2-juvenile-development-rate" id="toc-example-2-juvenile-development-rate" class="nav-link" data-scroll-target="#example-2-juvenile-development-rate">Example 2: Juvenile Development Rate</a>
  <ul class="collapse">
  <li><a href="#fitting-with-default-settings" id="toc-fitting-with-default-settings" class="nav-link" data-scroll-target="#fitting-with-default-settings">Fitting with default settings</a></li>
  <li><a href="#changing-fitting-arguments" id="toc-changing-fitting-arguments" class="nav-link" data-scroll-target="#changing-fitting-arguments">Changing Fitting arguments</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">Model Selection</a></li>
  </ul></li>
  <li><a href="#independent-practice" id="toc-independent-practice" class="nav-link" data-scroll-target="#independent-practice">Independent Practice</a>
  <ul class="collapse">
  <li><a href="#practice-option-1" id="toc-practice-option-1" class="nav-link" data-scroll-target="#practice-option-1">Practice Option 1</a></li>
  <li><a href="#practice-option-2" id="toc-practice-option-2" class="nav-link" data-scroll-target="#practice-option-2">Practice Option 2</a></li>
  <li><a href="#practice-option-3" id="toc-practice-option-3" class="nav-link" data-scroll-target="#practice-option-3">Practice Option 3</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction to Bayesian Methods</h1>
<p class="subtitle lead">Activity: Fitting TPCs using <code>bayesTPC</code></p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This section is focused on using the <code>bayesTPC</code> package to fit TPCs to data using the methods we’ve explored in the Bayesian lectures and the first two activities. Here we won’t be talking much about the implementation, but instead will rely on the <code>bayesTPC</code> package and it’s functions to allow us to specify, fit, and analyze the data.</p>
</section>
<section id="packages-and-tools" class="level1">
<h1>Packages and tools</h1>
<p>For this practical you will need to first install <a href="">nimble</a>, then be sure to install the following packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(HDInterval)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCvis)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda) <span class="co"># makes diagnostic plots</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(matrixStats)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(truncnorm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br> We are also introducing our new, in development, package <code>bayesTPC</code>. It is currently available through github.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("devtools")</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#devtools::install_github("johnwilliamsmithjr/bayesTPC")</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesTPC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-thermal-trait-data-for-aedes-mosquitoes" class="level1">
<h1>Fitting thermal trait data for <em>Aedes</em> mosquitoes</h1>
<p>We demonstrate the basic workflow of <code>bayesTPC</code> by fitting TPC curves to <em>Aedes aegypti</em> trait data from <span class="citation" data-cites="huxley2022competition">@huxley2022competition</span>. We use individual level data on three traits:</p>
<ul>
<li>juvenile survival (proportions – number of juveniles that become adults/total number of eggs)</li>
<li>development rate (1/time for a mosquito to develop)</li>
<li>adult longevity.</li>
</ul>
<p>Note that some of the traits/data are related to others, such as mortatlity rate $=$1/lifespan or development rate <span class="math inline">=</span> 1/development time if we’re assuming lifespan and development time, respectively, are exponentially distributed – a common modeling assumption.</p>
<p>These three trait sets allow us to explore a full range of models and functionality in <code>bayesTPC</code>.</p>
<section id="data-from-vectraits" class="level2">
<h2 class="anchored" data-anchor-id="data-from-vectraits">Data from VecTraits</h2>
<p>The data we want to fit is available on the VecTraits database. We can use the helper function included as part of <code>bayesTPC</code> that is designed to interact with this database, <code>get_datasets()</code>, along with the appropriate data set id numbers to retrieve and load them into <code>R</code>.</p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-3_0e2c1d67d9459141a5c9eec3fe01b81e">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>aedes_data <span class="ot">&lt;-</span> <span class="fu">get_datasets</span>(<span class="dv">577</span><span class="sc">:</span><span class="dv">579</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have downloaded all three datasets. As always, first we have a look at the data (just looking at a few columns, since the VecTraits format is large so it can hold a lot of different types of information):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cols<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">9</span>,<span class="dv">68</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>aedes1<span class="ot">&lt;-</span>aedes_data[[<span class="dv">3</span>]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(aedes1[,cols])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  DatasetID OriginalTraitName                        OriginalTraitDef
1       579         longevity individual-level duration of life stage
2       579         longevity individual-level duration of life stage
3       579         longevity individual-level duration of life stage
4       579         longevity individual-level duration of life stage
5       579         longevity individual-level duration of life stage
6       579         longevity individual-level duration of life stage
  OriginalTraitValue Interactor1Temp
1                 10              22
2                  9              22
3                  7              22
4                 11              22
5                 10              22
6                  6              22</code></pre>
</div>
</div>
<p>Trait data need to be in a particular format before being passed into the fitting routine. Specifically, the data must be stored as a list with names <code>Trait</code> for the modeled response and <code>Temp</code> for the corresponding temperature settings (in <span class="math inline">^\circ</span>C, as this is necessary for some of the TPC functions). We format the three datasets here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># development rate</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dev_rate <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Trait =</span> <span class="dv">1</span><span class="sc">/</span>aedes_data[[<span class="dv">2</span>]]<span class="sc">$</span>OriginalTraitValue,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Temp =</span> aedes_data[[<span class="dv">2</span>]]<span class="sc">$</span>Interactor1Temp)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># adult longevity</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>adult_life <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Trait =</span> aedes_data[[<span class="dv">3</span>]]<span class="sc">$</span>OriginalTraitValue,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Temp =</span> aedes_data[[<span class="dv">3</span>]]<span class="sc">$</span>Interactor1Temp)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># juvenile survival data</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>juv_survival <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Trait =</span> aedes_data[[<span class="dv">1</span>]]<span class="sc">$</span>OriginalTraitValue,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Temp =</span> aedes_data[[<span class="dv">1</span>]]<span class="sc">$</span>Interactor1Temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we follow a convention here treating the development rate as 1/development time. This is a common assumption (although it is formally only valid if we believe that development times are exponentially distributed). Often mathematical models assume exponentially distributed traits, and so this is why the data are modeled in this fashion. We will show this approach here, as it is common, but do not advocate for this in general.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plotData" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotData-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Three example datasets from <span class="citation" data-cites="huxley2022competition">@huxley2022competition</span>: Development Rate, Adult Longevity, and Juvenile Survival. Temperatures for the juvenile survival data are jittered for visibility</figcaption>
</figure>
</div>
</div>
</div>
<p>We will first go through a case where the default settings give reasonable output out of the box (adult lifespan) in order to show basic functions in action. We then approach a case where the defaults need to be modified (development rate). As part of your independent practice, you can fit data (juvenile survival) where we would use a glm model for the data.</p>
</section>
</section>
<section id="thermal-performance-curve-models-in-bayestpc" class="level1">
<h1>Thermal performance curve models in <code>bayesTPC</code></h1>
<p>There are many functional forms that can be used to describe TPCs. Two of the more common (and easy to fit) functions are quadratic and Briere. Traits that respond unimodally but symmetrically to temperature (often the case for compound traits) can be fit with a quadratic function: <span class="math display">
f_1(T) = \begin{cases} 0 &amp;\text {if } T \leq T_0 \\
-q (T-T_0) (T-T_m) &amp; \text {if } T_0 &lt; T &lt;T_m \\
0 &amp;\text{if } T \geq T_m . \end{cases}
</span></p>
<p>Traits that respond unimodally but asymetrically can be fitted with a Briere function: <span class="math display">
f_2(T) = \begin{cases} 0 &amp;\text {if } T \leq T_0 \\
q T (T-T_0) \sqrt{T_m-T} &amp; \text {if } T_0 &lt; T &lt;T_m \\
0 &amp;\text{if } T \geq T_m . \end{cases}
</span> In both models, <span class="math inline">T_0</span> is the lower thermal limit, <span class="math inline">T_m</span> is the upper thermal limit (i.e., where the trait value goes to zero on either end), and <span class="math inline">q&gt;0</span> determines the curvature, and so with the other parameters determines the height of the curve (i.e., value of the trait at the optimum temperature). Note that above we’re assuming that the quadratic must be concave down (hence the negative sign), and that the performance goes to zero outside of the thermal limits. In some cases we instead use a concave-up quadratic, although it must be parameterized differently.</p>
<p>We include eight common TPC models (listed with <code>get_models()</code>) in the package (<strong>?@tbl-TPCs</strong>). Users can obtain the default specification and priors for these models with <code>get_default_model_specification()</code>. The package also includes linear and quadratic formulations for Bernoulli, binomial, and Poisson GLMs, assuming canonical link functions .</p>
<div id="tbl-TPCs" class="tbl-parent quarto-layout-panel anchored">
<div class="panel-caption table-caption">
<p>Thermal performance curves included in <code>bayesTPC</code>.</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">

</div>
</div>
</div>
<p>For example, if you want to see all of the TPCs you run:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_models</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "poisson_glm_lin"    "poisson_glm_quad"   "binomial_glm_lin"  
 [4] "binomial_glm_quad"  "bernoulli_glm_lin"  "bernoulli_glm_quad"
 [7] "briere"             "gaussian"           "kamykowski"        
[10] "pawar_shsch"        "quadratic"          "ratkowsky"         
[13] "stinner"            "weibull"           </code></pre>
</div>
</div>
<p>We can view the form of the implemented TPC using the <code>get_formula</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_formula</span>(<span class="st">"briere"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression(q * Temp * (Temp - T_min) * sqrt((T_max &gt; Temp) * 
    abs(T_max - Temp)) * (T_max &gt; Temp) * (Temp &gt; T_min))</code></pre>
</div>
</div>
<p>Currently, the default likelihood for all TPCs a normal distribution with a lower truncation at zero, and where the mean of the normal distribution is set to be the TPC (here a quadratic). The last piece of the Bayesian puzzle is the prior. You can see the default parameter names and their default priors using “get_default_priors”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_priors</span>(<span class="st">"briere"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              q           T_max           T_min 
  "dunif(0, 1)" "dunif(25, 60)"  "dunif(0, 24)" </code></pre>
</div>
</div>
<p>As you can see, for the quadratic function, the default priors are specified via uniform distributions (the two arguments specific the lower and upper bounds, respectively). For the quadratic (and the Briere), the curvature parameter must be positive, and the priors need to be specified to ensure that <span class="math inline">T_{min}&lt;T_{max}</span>. Note that if you want to set a prior to a normal distribution, unlike in R and most other programs, in nimble (and thus <code>bayesTPC</code>) the inverse of the variance of the normal distribution is used, denoted by <span class="math inline">\tau = \frac{1}{\sigma^2}</span>.</p>
</section>
<section id="sec-fitting" class="level1">
<h1>Fitting using <code>bayesTPC</code></h1>
<p>The workhorse of the <code>bayesTPC</code> package is the <code>b_TPC</code> function which requires two user-specified inputs. The first is <code>data</code>; a list with expected entries named “Trait” corresponding to the trait being modeled by the TPC and “Temp” corresponding to the temperature in Celsius that the trait was measured at (as described above). The second input is <code>model</code>, which is a string specifying the model name or a <code>btpc_model</code> object. If a string is provided, the default model specification is used.</p>
</section>
<section id="example-1-adult-mosquito-lifespan" class="level1">
<h1>Example 1: Adult Mosquito Lifespan</h1>
<p>Let’s first explore the basic functionality of <code>bayesTPC</code> through an example on adult mosquito lifespan (the VecTraits dataset 579 downloaded above). We already formatted the dataset appropriately above for the <code>b_TPC()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(adult_life)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Trait Temp
1    10   22
2     9   22
3     7   22
4    11   22
5    10   22</code></pre>
</div>
</div>
<section id="inference-with-default-settings" class="level2">
<h2 class="anchored" data-anchor-id="inference-with-default-settings">Inference with default settings</h2>
<p>Once we have the data formatted as required by <code>b_TPC()</code>, we can fit each of the datasets with a single call, using the default settings. As we saw in the plot above, adult lifespan are numeric data where a concave down unimodal response is likely appropriate. For adult lifespan, we chose to fit a Briere function with the default specification:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_model_specification</span>(<span class="st">"briere"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC Model Specification of Type:
  briere

Model Formula:
  m[i] &lt;- ( q * Temp * (Temp - T_min) * sqrt((T_max &gt; Temp) * abs(T_max - Temp))
* (T_max &gt; Temp) * (Temp &gt; T_min) )

Model Distribution:
Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )

Model Parameters and Priors:
  q ~ dunif(0, 1) 
  T_max ~ dunif(25, 60) 
  T_min ~ dunif(0, 24)

Prior for Variance:
  sigma.sq ~ dexp(1)</code></pre>
</div>
</div>
<p>To fit the model then requires a single line of code with the first argument being the name of the formatted data object and the second being the name of the TPC that we want to use for fitting. By default we take 10000 samples, no burn-in, using a random walk sampler.</p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-12_38e787969b24087e469c087882424479">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>adult_life_fit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(adult_life, <span class="st">"briere"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the fitting process has completed (which can take a few minutes), we can have a gander at the fitted model object using <code>print</code>. This command provides details about the model fit, the priors, and some simple summaries of the fitted model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(adult_life_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC MCMC of Type:
  briere

Formula:
  m[i] &lt;- ( q * Temp * (Temp - T_min) * sqrt((T_max &gt; Temp) * abs(T_max - Temp))
* (T_max &gt; Temp) * (Temp &gt; T_min) )

Distribution:
Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )

Parameters:
            MAP   Mean Median        Priors
T_max    34.437 34.280 34.413 dunif(25, 60)
T_min     0.003  3.657  1.419  dunif(0, 24)
q         0.005  0.009  0.005   dunif(0, 1)
sigma.sq 16.423 18.715 17.128       dexp(1)</code></pre>
</div>
</div>
<p>We can also see what is in the object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(adult_life_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "samples"        "mcmc"           "data"           "model_spec"    
[5] "priors"         "constants"      "uncomp_model"   "comp_model"    
[9] "MAP_parameters"</code></pre>
</div>
</div>
<p>Most of what we do relies on the “samples” portion of the object, although <code>bayesTPC</code> has helper functions to reduce the need to interact with these directly in most cases.</p>
</section>
<section id="mcmc-diagnotic-plots" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-diagnotic-plots">MCMC Diagnotic Plots</h2>
<p><code>b_TPC()</code> returns an object of class <code>btpc_MCMC</code> which contains (along with model specification information and data) the MCMC samples as an <code>mcmc</code> object from the package <code>coda</code>. As mentioned in the previous portion of the training, it is important to check the MCMC traceplot before using or interpreting a fitted model to ensure the chains have converged. An MCMC traceplot shows each sample for a parameter in the order that the samples were taken. If the model has converged, the traceplot will eventually start varying around a single point, resembling a “fuzzy caterpillar”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>)<span class="sc">+</span>.<span class="dv">1</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(adult_life_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotTrace1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotTrace1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Traceplots for the three parameters of the Briere TPC and the observation parameter for model fitted to the Adult Longevity data.</figcaption>
</figure>
</div>
</div>
</div>
<p>We notice that it takes a while for the chains to converge. Thus we need to specify a burn-in period and only consider samples obtained after the burn-in. For this example, a burn-in of around 3000 should give us a good result. We can re-visualize with this burn-in (by adding burn=3000 as an argument to traceplot):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>)<span class="sc">+</span>.<span class="dv">1</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>myburn<span class="ot">&lt;-</span><span class="dv">3000</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(adult_life_fit, <span class="at">burn=</span>myburn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotTraceBurn1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotTraceBurn1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Traceplots for the three parameters of the Briere TPC and the observation parameter for model fitted to the Adult Longevity data. Here the burn-in portion of the MCMC chains has been dropped.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is much better! All of the chains now have the desired “fuzzy caterpillar” look. Typically one would at this point go back to the original fitting function, and specify the burn-in time, along with potentially increasing the total sample size in order to ensure sufficient samples. This approach drops the burnin samples from the returned object. For brevity herewe will simply specify the value of <code>burn</code> as an argument for the remaining plotting functions.</p>
<p>We can examine the ACF of the chains as well (one for each parameter), similarly to a time series, to again check for autocorrelation within the chain (we want the autocorrelation to be fairly low):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>s1<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(adult_life_fit<span class="sc">$</span>samples[myburn<span class="sc">:</span><span class="dv">10000</span>,])</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">bty=</span><span class="st">"n"</span>, <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">1</span>)<span class="sc">+</span>.<span class="dv">1</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(s1[,i], <span class="at">lag.max=</span><span class="dv">50</span>, <span class="at">main=</span><span class="st">""</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> <span class="fu">paste</span>(<span class="st">"ACF: "</span>, <span class="fu">names</span>(s1)[i], <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>There is still autocorrelation, especially for two of the quadratic parameters. The chain for <span class="math inline">\sigma</span> is mixing best (the ACF falls off the most quickly). We could reduce the autocorrelation even further by thinning the chain <strong>(i.e., change the <code>nt</code> parameter to 5 or 10)</strong>, or changing the type of sampler.</p>
<p>A second important diagnostic step is to compare the marginal priors and posteriors of our model parameters. This enables us to confirm that (unless we’ve purposefully specified an informative prior) that our posterior distributions have been informed by the data. <code>bayesTPC</code> includes a built in function, <code>ppo_plot()</code>, that creates posterior/prior overlap plots for all model parameters (note that the priors are smoothed because the algorithm uses kernel smoothing instead of the exact distribution).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>)<span class="sc">+</span>.<span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ppo_plot</span>(adult_life_fit, <span class="at">burn=</span>myburn, <span class="at">legend_position =</span> <span class="st">"topright"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotPP1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotPP1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Marginal prior/posterior for the three parameters of the Briere TPC and the observation parameter for the model fitted to the Adult Longevity data. Note that the burn-in is dropped for these plots using the <code>burn</code> argument.</figcaption>
</figure>
</div>
</div>
</div>
<p>The prior distribution here is very different from the posterior. These data are highly informative for the parameters of interest and are very unlikely to be influenced much by the prior distribution (although you can always change the priors to check this). However, notice that the posterior <span class="math inline">T_0</span> is slightly truncated by their priors. If priors and posteriors are very similar one should shift the priors, and re-run.</p>
</section>
<section id="additional-plotting" class="level2">
<h2 class="anchored" data-anchor-id="additional-plotting">Additional plotting</h2>
<p>After we have established appropriate burn-in values, we can use <code>plot()</code>, <code>posterior_predictive()</code>, and <code>plot_prediction()</code> to examine the fit of the model in two ways. The defaults for the <code>plot()</code> function plots the median and 95% Highest Posterior Density (HPD) interval of the <em>fitted function</em> (i.e., plugging the samples into the TPC function, and calculating the median and HPD interval at all evaluated temperatures). In contrast, the <code>posterior_predictive()</code> function uses simulation to draw points from the posterior predictive distribution, and so it includes both the samples describing the TPC function and the observational model. It then uses these samples to calculate the mean/median and the HPD interval of those simulated points. Both kinds of plots are shown in <a href="#fig-plotFit1">Figure&nbsp;5</a> for comparison.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plotFit1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotFit1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Comparison of the plots produced by the <code>plot()</code> function (LEFT) and the combination of the <code>posterior_predictive()</code>, and <code>plot_prediction()</code> functions (RIGHT). By default both functions would only make plots/predictions within the range of temperatures included in the fitted data. However here we show the use of the temp_interval argument to enable plotting of predictions across a broader temperature range.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that the two bottom fits show different output. On the left we show the HPD bounds and median of the fitted Briere function, only. On the right, in contrast, shows the bounds and mean/median of the posterior predictive distribution (so it includes the randomness that is part of the truncated normal observation model). Notice that the HPD predictive interval is a bit jagged here. These intervals are generated using sampling from the posterior predictive distribution. Increasing the total number of samples can give smoother bounds in general.</p>
<p>Now that we’ve confirmed that things are working well, it’s often useful to also look at the joint distribution of all of your parameters together to understand how estimates are related to each other. Of course, if you have a high dimensional posterior, rendering a 2-D representation can be difficult. The standard is to examine the pair-wise posterior distribution. We can do this using the function <code>bayesTPC_ipairs()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bayesTPC_ipairs</span>(adult_life_fit, <span class="at">burn=</span>myburn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotJoint1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotJoint1-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;6: Pairwise visualization of the joint posterior distribution of parameters for the three parameters of the Briere TPC and the observation parameter for the model fitted to the Adult Longevity data. Note that the burn-in is dropped for this plot using the <code>burn</code> argument.</figcaption>
</figure>
</div>
</div>
</div>
<p>Notice that there is substantial correlation between <span class="math inline">q</span> and <span class="math inline">T_{min}</span> (a.k.a., <span class="math inline">T_0</span>). This is typical for most TPCs, and is one of the reasons why prior choice can be very important!</p>
</section>
<section id="summaries" class="level2">
<h2 class="anchored" data-anchor-id="summaries">Summaries</h2>
<p>If we are satisfied with the traceplots, fits, and prior/posterior plots, users may want to examine additional summary output (for example to make tables) or to save summaries. Numerical summaries are available through the <code>print()</code> function shown above, but we can see more details using <code>summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(adult_life_fit, <span class="at">burn=</span>myburn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC MCMC of Type:
  briere

Formula:
  m[i] &lt;- ( q * Temp * (Temp - T_min) * sqrt((T_max &gt; Temp) * abs(T_max - Temp))
* (T_max &gt; Temp) * (Temp &gt; T_min) )

Distribution:
Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )

Priors:
  q ~ dunif(0, 1) 
  T_max ~ dunif(25, 60) 
  T_min ~ dunif(0, 24) 
  sigma.sq ~ dexp(1)

Max. A Post. Parameters: 
     T_max      T_min          q   sigma.sq   log_prob 
   34.4375     0.0033     0.0048    16.4227 -1925.8305 

MCMC Results:
Iterations = 1:10000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 10000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

              Mean      SD  Naive SE Time-series SE
T_max    34.279767 0.72466 0.0072466        0.09224
T_min     3.656669 6.08401 0.0608401        2.42313
q         0.009447 0.02875 0.0002875        0.00186
sigma.sq 18.715083 6.18689 0.0618689        2.34910

2. Quantiles for each variable:

              2.5%       25%       50%      75%    97.5%
T_max    32.219234 34.329692 34.413434 34.50093 34.68285
T_min     0.038791  0.631755  1.418772  2.84041 23.85656
q         0.004687  0.004937  0.005113  0.00543  0.05025
sigma.sq 14.924233 16.336092 17.127976 18.09105 43.55782</code></pre>
</div>
</div>
<p>We may want to store some of the sample statistics for later use. The sample-based Maximum <em>a posteriori</em> (MAP) estimator is calculated and saved as part of our fitting process, and can be obtained directly from the fit object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAP estimator</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>adult_life_fit<span class="sc">$</span>MAP_parameters <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      T_max       T_min           q    sigma.sq    log_prob 
   34.43748     0.00333     0.00483    16.42274 -1925.83048 </code></pre>
</div>
</div>
<p>The other sample statistics for each parameter can be obtained by saving the summary of the <em>samples</em> in the fitted model object. Then the various statistics may be extracted directly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">summary</span>(adult_life_fit<span class="sc">$</span>samples)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>statistics[,<span class="st">"Mean"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       T_max        T_min            q     sigma.sq 
34.279766916  3.656668558  0.009447264 18.715083401 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Median and 95% CI bounds</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>quantiles[,<span class="fu">c</span>(<span class="st">"2.5%"</span>, <span class="st">"50%"</span>, <span class="st">"97.5%"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 2.5%          50%       97.5%
T_max    32.219234174 34.413434495 34.68285344
T_min     0.038790561  1.418771736 23.85656106
q         0.004687329  0.005113463  0.05024568
sigma.sq 14.924232641 17.127976309 43.55782109</code></pre>
</div>
</div>
<p>If one instead would like the Highest Posterior Density bounds (instead of the quantile based summaries) the <code>HPDinterval</code> function from <code>coda</code> may be used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">HPDinterval</span>(adult_life_fit<span class="sc">$</span>samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                lower       upper
T_max    3.233442e+01 34.76907958
T_min    3.894801e-04 22.99053975
q        4.628532e-03  0.03363878
sigma.sq 1.417072e+01 40.15128418
attr(,"Probability")
[1] 0.95</code></pre>
</div>
</div>
</section>
</section>
<section id="example-2-juvenile-development-rate" class="level1">
<h1>Example 2: Juvenile Development Rate</h1>
<p>We will use a second example to explore simple modifications that can be made to the baseline fitting routines, especially changing of priors and modification of the default sampler.</p>
<section id="fitting-with-default-settings" class="level2">
<h2 class="anchored" data-anchor-id="fitting-with-default-settings">Fitting with default settings</h2>
<p>The default priors chosen in <code>bayesTPC</code> are generally as non-restrictive as possible, which can lead to inappropriate fits when the response trait is very close to zero. In this case it may be necessary to modify the priors. It is also possible that mixing may be poor with the default sampler, and so we may need to update the sampling method. We briefly show these issues using the development rate data as an example. These data are also numeric and we assume, again, a Briere functional response:</p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-25_a730706e07b1f3c76c408f092dfd6285">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dev_rate_fit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(dev_rate, <span class="st">"briere"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However in this case, although the traceplots look ok (after a burnin) the fits are very poor (<a href="#fig-plotDevRate1">Figure&nbsp;7</a>)</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plotDevRate1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotDevRate1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;7: Traceplots for the three parameters of the Briere TPC and the observation parameter for model fitted to the juvenile development data. (top 4 panels) with the data (bottom left) and corresponding posterior predictive (bottom right) plots based on these samples. The burn-in portion of the MCMC chains has been dropped.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can see a bit of what is going on by looking at the marginal prior/posterior plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>)<span class="sc">+</span>.<span class="dv">1</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ppo_plot</span>(dev_rate_fit, <span class="at">burn=</span>myburn, <span class="at">legend_position =</span> <span class="st">"topright"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotPP2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotPP2-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;8: Marginal prior/posterior for the three parameters of the Briere TPC and the observation parameter for the model fitted to the Juvenile development rate data. Note that the burn-in is dropped for these plots using the <code>burn</code> argument.</figcaption>
</figure>
</div>
</div>
</div>
<p>Here the posterior for <span class="math inline">q</span> is effectively the same as the prior, and both <span class="math inline">T_{min}</span> and <span class="math inline">T_{max}</span> are bumping up against the edges of their ranges.</p>
</section>
<section id="changing-fitting-arguments" class="level2">
<h2 class="anchored" data-anchor-id="changing-fitting-arguments">Changing Fitting arguments</h2>
<p>In order to try to improve the fitting, we will modify the priors and the sampler. We notice from the plot of the data that the rate seems to increase across the observed range of the data. Thus it is likely that the <span class="math inline">T_{\mathrm{max}}</span> parameter is at or above the temperature manipulated in the experiment and <span class="math inline">T_{\mathrm{min}}</span> is below. We can pass this information in as new priors through the <code>priors</code> argument as shown. Further, we can switch to a sampler that has a better chance of converging by modifying the <code>samplerType</code> parameter. Here, we use automated factor slice sampling. Although this sampler is often more effective (especially when parameters are highly correlated, as they are for most TPCs), it is slower and so is not used by default. These changes result in much better fits (see <a href="#fig-plotDevRate2">Figure&nbsp;9</a>).</p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-28_1dcbc359b60f16817c8615ab02eb1edb">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dev_rate_fit2 <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(dev_rate, <span class="st">"briere"</span>,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">T_min =</span> <span class="st">"dunif(0,22)"</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">T_max =</span> <span class="st">"dunif(34,50)"</span>),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">burn=</span>myburn,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">samplerType =</span> <span class="st">"AF_slice"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plotDevRate2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotDevRate2-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;9: Traceplots for the three parameters of the Briere TPC and the observation parameter for the model fitted to the juvenile development data (top 4 panels) with the corresponding summary (bottom left) and posterior predictive (bottom right) plots based on these samples. The burn-in portion of the MCMC chains has been dropped as part of the fitting.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is much better! The chains mix well, and our predictions now lie along with the data. If you were to plot the autocorrelation you would notice that it falls off much more quickly.</p>
</section>
<section id="model-selection" class="level2">
<h2 class="anchored" data-anchor-id="model-selection">Model Selection</h2>
<p>What if we didn’t know that the Briere was the preferred model for these development rate data? We can fit with another function, check all of the diagnostics, and then compare via WAIC (Widely Applicable Information Criterion) to choose between them. For the juvenile development rate, let’s try a quadratic. Let’s look at the implementation details:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_formula</span>(<span class="st">"quadratic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression(-1 * q * (Temp - T_min) * (Temp - T_max) * (T_max &gt; 
    Temp) * (Temp &gt; T_min))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_priors</span>(<span class="st">"quadratic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              q           T_max           T_min 
  "dunif(0, 1)" "dunif(25, 60)"  "dunif(0, 24)" </code></pre>
</div>
</div>
<p>I will refit using the default priors, except for the prior for <span class="math inline">q</span> (so you can see an option):</p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-32_d90ff46b7da2194c1790cdac7cd772b7">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dev_rate_fit_Quad <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> dev_rate, <span class="do">## data</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model =</span> <span class="st">'quadratic'</span>, <span class="do">## model to fit</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">niter =</span> <span class="dv">10000</span>, <span class="do">## total iterations</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">burn =</span> <span class="dv">3000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">q =</span> <span class="st">'dexp(1)'</span>) <span class="do">## priors</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                    ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dev_rate_fit_Quad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC MCMC of Type:
  quadratic

Formula:
  m[i] &lt;- ( -1 * q * (Temp - T_min) * (Temp - T_max) * (T_max &gt; Temp) * (Temp &gt;
T_min) )

Distribution:
Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )

Priors:
  q ~ dexp(1) 
  T_max ~ dunif(25, 60) 
  T_min ~ dunif(0, 24) 
  sigma.sq ~ dexp(1)

Max. A Post. Parameters: 
    T_max     T_min         q  sigma.sq  log_prob 
  55.7754   16.2251    0.0004    0.0003 1855.7913 

MCMC Results:
Iterations = 1:7000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 7000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

              Mean        SD  Naive SE Time-series SE
T_max    5.600e+01 1.963e+00 2.346e-02      7.950e-02
T_min    1.619e+01 3.420e-01 4.088e-03      1.298e-02
q        3.625e-04 3.797e-05 4.539e-07      1.600e-06
sigma.sq 2.863e-04 1.512e-05 1.808e-07      1.943e-07

2. Quantiles for each variable:

              2.5%       25%       50%       75%     97.5%
T_max    5.242e+01 5.452e+01 5.596e+01 5.750e+01 5.958e+01
T_min    1.554e+01 1.594e+01 1.619e+01 1.643e+01 1.683e+01
q        3.014e-04 3.328e-04 3.599e-04 3.884e-04 4.396e-04
sigma.sq 2.580e-04 2.760e-04 2.858e-04 2.959e-04 3.169e-04</code></pre>
</div>
</div>
<p>We again plot the chains of the three main TPC parameters and the standard deviation of the normal observation model:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plotDevRate3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="bayesTPC_activity_files/figure-html/fig-plotDevRate3-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;10: Traceplots for the three parameters of the quadratic TPC and the observation parameter for the model fitted to the juvenile development data (top 4 panels) with the corresponding summary (bottom left) and posterior predictive (bottom right) plots based on these samples. The burn-in portion of the MCMC chains has been dropped.</figcaption>
</figure>
</div>
</div>
</div>
<p>Once fitted, we want to be able to choose which of these models is best for these data. Although, <em>a priori</em> we would expect the Briere fit to be best development rates, both fits seem visually reasonable. We can extract the the values of the wAIC <span class="citation" data-cites="watanabe2009algebraic">[@watanabe2009algebraic]</span> to compare the performance of our models using <code>get_WAIC()</code> (which wraps <code>nimble</code>’s <code>getWAIC()</code> function and produces a tidier format). The preferred model will be the one with the lowest wAIC value. <em>Note that because this is based on samples, you want to have the same number of samples in the chains for each of the models you are comparing.</em></p>
<div class="cell" data-hash="bayesTPC_activity_cache/html/unnamed-chunk-35_8aa7a35e1ae5b1ef3aac63d621af831c">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(dev_rate_fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        WAIC         lppd        pWAIC 
-3731.931421  1870.413188     4.447478 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(dev_rate_fit_Quad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       WAIC        lppd       pWAIC 
-3717.61365  1862.64185     3.83502 </code></pre>
</div>
</div>
<p>In this case the WAIC for the Briere fit is more negative and so is the preferred model.</p>
</section>
</section>
<section id="independent-practice" class="level1">
<h1>Independent Practice</h1>
<section id="practice-option-1" class="level2">
<h2 class="anchored" data-anchor-id="practice-option-1">Practice Option 1</h2>
<p>For the <em>Aedes aegypti</em> life span data, try to fit 3 TPC functional forms (Briere, quadratic, and Stinner) to the data. Use slice sampling for all three of them, and make the chains a bit longer (say 15000 plus the 3000 burnin). Check all of the diagnostics for all models, and plot the fits. Then compare the three models via WAIC. Which one comes out on top.</p>
</section>
<section id="practice-option-2" class="level2">
<h2 class="anchored" data-anchor-id="practice-option-2">Practice Option 2</h2>
<p>You can download some other trait data from the <a href="https://vectorbyte.crc.nd.edu/vectraits-explorer">VectorByte – VecTraits Databases</a> or use your own data. Write you own analysis as an independent, self-sufficient <code>R</code> script that produces all the plots in a reproducible workflow when sourced. Use the appropriate functional forms for your data.</p>
</section>
<section id="practice-option-3" class="level2">
<h2 class="anchored" data-anchor-id="practice-option-3">Practice Option 3</h2>
<p>In addition to the two datasets that we explored here, we downloaded data on juvenile survival. These data are encoded as zeros and ones, and are more appropriately modeled using a Bernoulli/Binomial distribution – that is as GLMs. <code>bayesTPC</code> has implemented two options for fitting these models, either a linear or quadratic:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Linear:</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_model_specification</span>(<span class="st">"bernoulli_glm_lin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC Model Specification of Type:
  bernoulli_glm_lin

Model Formula:
  logit(m[i]) &lt;- ( B0 + B1 * Temp )

Model Distribution:
Trait[i] ~ dbern(m[i])

Model Parameters and Priors:
  B0 ~ dnorm(0, 500) 
  B1 ~ dnorm(0, 500)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Quadratic:</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_model_specification</span>(<span class="st">"bernoulli_glm_quad"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bayesTPC Model Specification of Type:
  bernoulli_glm_quad

Model Formula:
  logit(m[i]) &lt;- ( B0 + B1 * Temp + B2 * (Temp)^2 )

Model Distribution:
Trait[i] ~ dbern(m[i])

Model Parameters and Priors:
  B0 ~ dnorm(0, 500) 
  B1 ~ dnorm(0, 500) 
  B2 ~ dnorm(0, 500)</code></pre>
</div>
</div>
<p>Fit the juvenile survival data using both of these models. Note that the slice sampler is typically better for these, and you will likely need a longer chain and more burn-in. Make sure to use the same number of samples/burn-in for both models. Check all the diagnostic plots and plot the data with the fits. Then use WAIC to choose between the two model variants. What do you conclude?</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>